<script type='text/javascript' src='http://code.jquery.com/jquery-2.1.1.min.js'></script>
<script type='text/javascript' src='https://cdn.socket.io/socket.io-1.0.4.js'></script>

<canvas id='canvas' height='600' width='1000' style='border: 1px solid #000'></canvas>
<br /><br /><a href="https://github.com/emoose/openhotel">Fork my repo on github</a><br />

<script type='text/javascript'>

	var id = ""
	var x = 0;
	var y = 0;
	var newX = 0;
	var newY = 0;
	var mouseX = 0;
	var mouseY = 0;
	var defaultSpeed = 0.5;
    var monsterSpeed = 0.55;
	var players = [];
	var blockSize=10;
	var socket = io.connect();
	var ctx = $("#canvas")[0].getContext("2d");
	
	//get id
	socket.emit("ID", {id:""})
	socket.on("ID", function(data){
		id=data.ID
	})
	//add new player to our list
	socket.on("newPlayer", function(data){
		players.push({id:data.id,x:data.x,y:data.y,newX:data.x,newY:data.y,monster:data.monster,connected:data.connected})
	})
	//update our player list with updated player pos
	socket.on("updatePlayer", function(data){
		for(p=0;p<players.length;p++){
			if(players[p].id==data.id){
				players[p].newX = data.x;
				players[p].newY = data.y;
                players[p].monster = data.monster;
                players[p].connected = data.connected;
				break;
			}
		}
	});
    
    socket.on("refresh", function(data){
        setTimeout(function(){ window.location.reload(1); }, 1000);
    });

	function draw(){
		ctx.clearRect(0,0,1000,600);

		for(p=0;p<players.length;p++){
                if(players[p].connected == 0)
                    continue;
                var speed = (players[p].monster == 1 ? monsterSpeed : defaultSpeed);
                    
				if(players[p].x<players[p].newX){
					players[p].x+=speed;
				}
				if(players[p].x>players[p].newX){
					players[p].x-=speed;
				}
				if(players[p].y<players[p].newY){
					players[p].y+=speed;
				}
				if(players[p].y>players[p].newY){
					players[p].y-=speed;
				}
				
				ctx.beginPath();
				if(players[p].monster == 1)
                {
					ctx.fillStyle="#00FF00";
                    if(players[p].id == id)
                    {
                        // player is monster and player is us
                        var ourX = Math.floor(players[p].x / 10);
                        var ourY = Math.floor(players[p].y / 10);
                        for(py=0;py<players.length;py++)
                        {
                            if(players[py].monster == 1 || players[py].id == players[p].id)
                                continue;
                            var vX = Math.floor(players[py].x / 10);
                            var vY = Math.floor(players[py].y / 10);
                            
                            if((vX == ourX && (vY == (ourY - 1) || vY == (ourY + 1))) || (vY == ourY && (vX == (ourX - 1) || vX == (ourX + 1))))
                            //if(vX 
                            {
                                socket.emit("infect", {id:id, victimid: players[py].id});
                                players[py].monster = 1;
                            }
                        }
                    }
                }else if(players[p].id==id){
					ctx.fillStyle="#FF0000";
				}else{
					ctx.fillStyle="#000";
				}
				ctx.fillRect(players[p].x,players[p].y,10,10)
				ctx.closePath();
		}

		ctx.beginPath();
		ctx.moveTo(mouseX,mouseY)
		ctx.lineTo(mouseX+blockSize,mouseY)
		ctx.moveTo(mouseX+blockSize,mouseY)
		ctx.lineTo(mouseX+blockSize,mouseY+blockSize)
		ctx.moveTo(mouseX+blockSize,mouseY+blockSize)
		ctx.lineTo(mouseX,mouseY+blockSize)
		ctx.moveTo(mouseX,mouseY+blockSize)
		ctx.lineTo(mouseX,mouseY)
		ctx.stroke()
		ctx.closePath();

	}

	$(document).mousemove(function(e){
		var x,y
		for(x=e.pageX-8;x>=0;x--){
			if(x%blockSize==0){
				mouseX = x
				break;
			}
		}
		for(y=e.pageY-8;y>=0;y--){
			if(y%blockSize==0){
				mouseY = y
				break;
			}
		}
	})
	$(document).mousedown(function(e){
		socket.emit("position", {id:id,x:mouseX,y:mouseY})
	})
	
	setInterval(draw,10);

var chat_open = false;
var chat_loaded = false;
var chat_channel = 'r';
function toggle_chat(){
	if (chat_open === false && chat_loaded == false) {
    	var chat_sidebar = document.createElement("div");
    	chat_sidebar.setAttribute("id", "chat_sidebar");
    	//var test_string = window.location.pathname.match(/draw\/([a-z0-9]+)/);
    	//if (test_string)
    	//	chat_channel = test_string[1];
    	//else
    	//	chat_channel = 'g';
    	chat_sidebar.style.position = "absolute";
    	chat_sidebar.style.top = document.width < 600 ? "20px" : '30%';
    	chat_sidebar.style.bottom = "0";
		chat_sidebar.style.right = "0";
		chat_sidebar.style.width = "400px";
		chat_sidebar.style.maxWidth = "100%";
		chat_sidebar.style.display = 'block';
		chat_sidebar.innerHTML = "<div style='margin-top:-20px;'>\
								  <div onclick='toggle_chat();'\
								  	style='height:20px;width:100%;background:#00930a;color:white;margin-top:0px;margin-left:0px;\
								  	border-top-left-radius:3px;\
								  	margin-right:-1px;'>\
								  <div style='float:left;' id='chat_button'>&#x25BC; hide chat - powered by livechan</div><br>\
								  <br></div>\
		<iframe id='chat_frame' style='position:absolute;width:100%;height:100%;border:none;right:0;'></iframe></div></div>";
		chat_sidebar.getElementsByTagName('iframe')[0].src = 'https://livechan.net/chat/' + chat_channel;
		//document.getElementById('chat_button').innerHTML = 'hide chat (powered by livechan)';
		chat_open = true;
    	document.body.appendChild(chat_sidebar);
		chat_loaded = true;
		if (document.width < 600) {
    		toggle_chat();
		}
		
	} else if (chat_open === true && chat_loaded == true){
		document.getElementById('chat_frame').style.display = 'none';
		document.getElementById('chat_sidebar').style.top = '100%';
		document.getElementById('chat_button').innerHTML = '&#x25B2; chat - powered by livechan';
		chat_open = false;
	} else if (chat_open === false && chat_loaded == true){
		document.getElementById('chat_frame').style.display = 'block';
		document.getElementById('chat_sidebar').style.top = document.width < 600 ? "20px" : '30%';
		document.getElementById('chat_button').innerHTML = '&#x25BC; hide chat - powered by livechan';
		chat_open = true;
		scroll_sidebar();
	}
	function scroll_sidebar(){
		var sidebar_check = document.getElementById("chat_frame");
		if (typeof(sidebar_check) != 'undefined' && sidebar_check != null) {
			sidebar_check.contentWindow.scroll();
		} else {
			console.log("sidebar not found :(");
		}
	}
}

toggle_chat();
</script>