<!DOCTYPE html>
<html lang="en"> 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" type="text/css" href="style.css">
<title>OpenHotel</title>
</head>
<body>
<script type='text/javascript' src='http://code.jquery.com/jquery-2.1.1.min.js'></script>
<script type='text/javascript' src='https://cdn.socket.io/socket.io-1.0.4.js'></script>
<canvas id='canvas' height='600' width='1000' style='border: 1px solid #000'></canvas><br><br>
<div id='event_log' style='width:1000px;height:100px;overflow:scroll;background-color:#EBEBEB'></div>
<input type="checkbox">Show disconnected players' last positions</input><br>
<a href="https://github.com/emoose/openhotel">Fork my repo on github</a><br>
Username: <input type="text" name="username_changer" id="username_changer" /> 
<input type="button" name="username_button" id="username_button" value="Set"/><br>
Background: <input type="text" name="bg_changer" id="bg_changer" /> 
<input type="button" name="bg_button" id="bg_button" value="Set"/>
<br>
<p>With thanks to BeetRoot for initial idea + code</p>
<div id='chat_sidebar'>
	<div style='margin-top:-20px;'>
		<div onclick='toggle_chat();' style='height:20px; width:100%; background:#00930a;color:white;margin-top:0px; 
		margin-left:0px; border-top-left-radius:3px; margin-right:-1px;'>
			<div style='float:left;' id='chat_button'>&#x25BC; hide chat - powered by livechan
			</div><br><br>
		</div>
	</div>
	<iframe id='chat_frame' style='position:absolute;width:100%;height:100%;border:none;right:0;'></iframe>
</div>
<script type='text/javascript'>
var hidden, visibilityChange; 
if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support 
  hidden = "hidden";
  visibilityChange = "visibilitychange";
} else if (typeof document.mozHidden !== "undefined") {
  hidden = "mozHidden";
  visibilityChange = "mozvisibilitychange";
} else if (typeof document.msHidden !== "undefined") {
  hidden = "msHidden";
  visibilityChange = "msvisibilitychange";
} else if (typeof document.webkitHidden !== "undefined") {
  hidden = "webkitHidden";
  visibilityChange = "webkitvisibilitychange";
}
 
var videoElement = document.getElementById("videoElement");

// If the page is hidden, pause the video;
// if the page is shown, play the video
function handleVisibilityChange() {
  if (document[hidden]) {
    for(p=0;p<players.length;p++){
        players[p].x = players[p].newX;
        players[p].y = players[p].newY;
    }
  }
}

document.addEventListener(visibilityChange, handleVisibilityChange, false);


	var id = "";
    var sessionID = 0;
    var gameSizeX = 0;
    var gameSizeY = 0;
	var x = 0;
	var y = 0;
	var newX = 0;
	var newY = 0;
	var mouseX = 0;
	var mouseY = 0;
	var speedPlayer = 0.5;
    var speedMonster = 0.55;
	var players = [];
	var blockSize=10;
	var socket = io.connect();
	var ctx = $("#canvas")[0].getContext("2d");
    var showDisconnected = 0;
    var img = new Image;
    var imgLoaded = 0;
    img.src = "";
    img.onload = function(){ imgLoaded = 1; }
    
$(":checkbox").click(function() {
    showDisconnected = $(this).is(":checked") ? 1 : 0;
});

function addToLog(entry)
{
    var log = $("#event_log").html();
    var safeent = $("<div/>").html(entry).text();
    log = safeent + "<br />" + log;
    $("#event_log").html(log);
}

function updateUsername()
{
    var name = $("#username_changer").val();
    if(name.length > 256) { alert('s-sempai, your name is too big for me...'); return; }
    socket.emit("username", {id: id, username: $("#username_changer").val(), session: sessionID});
}

function updateBackground()
{
    socket.emit("updateImage", {id: id, src: $("#bg_changer").val(), session: sessionID});
}

$("#username_button").click(updateUsername);
$("#bg_button").click(updateBackground);
$("#username_changer").keypress(function(event)
{
    if(event.which == 13 || event.keyCode == 13) updateUsername();
});
$("#bg_changer").keypress(function(event)
{
    if(event.which == 13 || event.keyCode == 13) updateBackground();
});

function getPlayerName(playerid)
{
    for(p=0;p<players.length;p++)
    {
        if(players[p].id!==playerid) continue;
        if(players[p].username !== undefined && players[p].username !== '')
            return 'Player ' + playerid + ' "' + players[p].username + '"';
        return 'Player ' + playerid;
    }
    return 'Unknown player';
}
	
	//get id
	socket.emit("ID", {id:""});
    
	socket.on("ID", function(data)
    {
		id=data.id;
        sessionID = data.session;
        gameSizeX = data.x;
        gameSizeY = data.y;
        img.src = data.image;
        imgLoaded = 0;
        img.onload = function(){ imgLoaded = 1; }
        console.log('connected, id ' + id + ' session ' + sessionID);
	});
    
	//add new player to our list
	socket.on("newPlayer", function(data)
    {
		players.push({id: data.id, x: data.x, y: data.y, newX: data.x, newY: data.y, monster: data.monster, connected: data.connected});
        addToLog('New player (ID ' + data.id + ') connected!');
	});
    
	//update our player list with updated player pos
	socket.on("updatePlayer", function(data)
    {
		for(p=0;p<players.length;p++)
        {
			if(players[p].id!==data.id) continue;
            
            var player = players[p];
            
            player.newX = data.x;
            player.newY = data.y;
            player.connected = data.connected;
            if(player.username !== data.username && data.username !== undefined && data.username !== '')
                addToLog(getPlayerName(data.id) + ' changed name to "' + data.username + '"');

            player.username = data.username;
            
            if(player.monster !== data.monster && data.monster == 1)
            {
                var attacker = " has become infected!";
                if(data.attackerid !== undefined && data.attackerid > 0)
                    attacker = " was bit by " + getPlayerName(data.attackerid) + "!";
                addToLog(getPlayerName(data.id) + attacker);
            }
            player.monster = data.monster;
            break;
		}
	});
    
    socket.on("refresh", function(data)
    {
        setTimeout(function(){ window.location.reload(1); }, 1000);
    });
    
    socket.on("updateImage", function(data)
    {
        img.src = data.src;
        img.onload = function(){ imgLoaded = 1; }
        imgLoaded = 0;
    });

	function draw()
    {
		ctx.clearRect(0,0,1000,600);
        if(imgLoaded === 1)
            ctx.drawImage(img,0,0);
		for(p=0;p<players.length;p++){
                if(window.location.pathname !== '/all' && players[p].connected == 0 && showDisconnected == 0)
                    continue;
                var speed = speedPlayer;
                    
				if(players[p].x<players[p].newX){
					players[p].x+=speed;
				}
				if(players[p].x>players[p].newX){
					players[p].x-=speed;
				}
				if(players[p].y<players[p].newY){
					players[p].y+=speed;
				}
				if(players[p].y>players[p].newY){
					players[p].y-=speed;
				}
				
				ctx.beginPath();
                if(players[p].id==id)
                {
					ctx.fillStyle="#FF0000";
                } else if(players[p].monster == 1)
                {
					ctx.fillStyle="#00FF00";
                    /*if(players[p].id == id)
                    {
                        // player is monster and player is us
                        var ourX = Math.floor(players[p].x / 10);
                        var ourY = Math.floor(players[p].y / 10);
                        for(py=0;py<players.length;py++)
                        {
                            if(players[py].monster == 1 || players[py].id == players[p].id)
                                continue;
                            var vX = Math.floor(players[py].x / 10);
                            var vY = Math.floor(players[py].y / 10);
                            
                            if((vX == ourX && (vY == (ourY - 1) || vY == (ourY + 1))) || (vY == ourY && (vX == (ourX - 1) || vX == (ourX + 1))))
                            //if(vX 
                            {
                                socket.emit("infect", {id:id, victimid: players[py].id});
                                players[py].monster = 1;
                            }
                        }
                    }*/
				}else{
					ctx.fillStyle="#000";
				}
				ctx.fillRect(players[p].x,players[p].y,10,10);
                if(players[p].id == id && players[p].monster == 1)
                {
                    ctx.fillStyle = "#00FF00";
                    ctx.fillRect(players[p].x + 1, players[p].y + 1, 8, 8);
                }
                var name = players[p].id;
                if(players[p].username != '' && players[p].username !== undefined)
                    name = name + '. ' + players[p].username;
                    
                ctx.font = "12px Arial";
                ctx.textAlign = 'center';
                ctx.fillText(name, players[p].x+blockSize/2, players[p].y+blockSize+12);
                
				ctx.closePath();
		}

		ctx.beginPath();
		ctx.moveTo(mouseX,mouseY)
		ctx.lineTo(mouseX+blockSize,mouseY)
		ctx.moveTo(mouseX+blockSize,mouseY)
		ctx.lineTo(mouseX+blockSize,mouseY+blockSize)
		ctx.moveTo(mouseX+blockSize,mouseY+blockSize)
		ctx.lineTo(mouseX,mouseY+blockSize)
		ctx.moveTo(mouseX,mouseY+blockSize)
		ctx.lineTo(mouseX,mouseY)
		ctx.stroke()
		ctx.closePath();

	}

	$(document).mousemove(function(e){
		var x,y
		for(x=e.pageX-8;x>=0;x--){
			if(x%blockSize==0){
				mouseX = x
				break;
			}
		}
		for(y=e.pageY-8;y>=0;y--){
			if(y%blockSize==0){
				mouseY = y
				break;
			}
		}
	});
	$(document).mousedown(function(e){
		socket.emit("position", {id:id,x:mouseX,y:mouseY,session:sessionID});
	});
	
	setInterval(draw,10);

var chat_open = false;
var chat_loaded = false;
var chat_channel = 'r';
function toggle_chat(){
	if (chat_open === false && chat_loaded == false) {
    	var chat_sidebar = document.getElementById("chat_sidebar");
		chat_sidebar.getElementsByTagName('iframe')[0].src = 'https://livechan.net/chat/' + chat_channel;
		document.getElementById('chat_frame').style.display = 'block';
		document.getElementById('chat_sidebar').style.top = document.width < 600 ? "20px" : '30%';
		document.getElementById('chat_button').innerHTML = '&#x25BC; hide chat - powered by livechan';
		chat_open = true;
		chat_loaded = true;
		if (document.width < 600) {
    		toggle_chat();
		}
		
	} else if (chat_open === true && chat_loaded == true){
		document.getElementById('chat_frame').style.display = 'none';
		document.getElementById('chat_sidebar').style.top = '100%';
		document.getElementById('chat_button').innerHTML = '&#x25B2; chat - powered by livechan';
		chat_open = false;
	} else if (chat_open === false && chat_loaded == true){
		document.getElementById('chat_frame').style.display = 'block';
		document.getElementById('chat_sidebar').style.top = document.width < 600 ? "20px" : '30%';
		document.getElementById('chat_button').innerHTML = '&#x25BC; hide chat - powered by livechan';
		chat_open = true;
		scroll_sidebar();
	}
	function scroll_sidebar(){
		var sidebar_check = document.getElementById("chat_frame");
		if (typeof(sidebar_check) != 'undefined' && sidebar_check != null) {
			sidebar_check.contentWindow.scroll();
		} else {
			console.log("sidebar not found :(");
		}
	}
}

toggle_chat();
</script>
</body>
</html>
