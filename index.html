<!DOCTYPE html>
<html lang="en"> 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" type="text/css" href="style.css">
<title>OpenHotel</title>
</head>
<body>
<script type='text/javascript' src='http://code.jquery.com/jquery-2.1.1.min.js'></script>
<script type='text/javascript' src='https://cdn.socket.io/socket.io-1.0.4.js'></script>
<canvas id='canvas' height='600' width='1000' style='border: 1px solid #000'></canvas><br><br>
<div id='event_log' style='width:1000px;height:100px;overflow:scroll;background-color:#EBEBEB'></div>
<input type="checkbox" id="dc_toggle">Show disconnected players' last positions</input><br>
<input type="checkbox" id="zombie_toggle">Disable zombies mode</input><br>
<a href="https://github.com/emoose/openhotel">Fork my repo on github</a><br>
Username: <input type="text" name="username_changer" id="username_changer" /> 
<input type="button" name="username_button" id="username_button" value="Set"/><br>
<!--Room: <input type="text" name="room_changer" id="room_changer" /> 
<input type="button" name="room_button" id="room_button" value="Set"/><br>-->
Background: <input type="text" name="bg_changer" id="bg_changer" /> 
<input type="button" name="bg_button" id="bg_button" value="Set"/>
<br>
<p>With thanks to BeetRoot for initial idea + code</p>
<div id='chat_sidebar'>
	<div style='margin-top:-20px;'>
		<div onclick='toggle_chat();' style='height:20px; width:100%; background:#00930a;color:white;margin-top:0px; 
		margin-left:0px; border-top-left-radius:3px; margin-right:-1px;'>
			<div style='float:left;' id='chat_button'>&#x25BC; hide chat - powered by livechan
			</div><br><br>
		</div>
	</div>
	<iframe id='chat_frame' style='position:absolute;width:100%;height:100%;border:none;right:0;'></iframe>
</div>
<script type='text/javascript'>
    var hidden, visibilityChange; 
    if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support 
      hidden = "hidden";
      visibilityChange = "visibilitychange";
    } else if (typeof document.mozHidden !== "undefined") {
      hidden = "mozHidden";
      visibilityChange = "mozvisibilitychange";
    } else if (typeof document.msHidden !== "undefined") {
      hidden = "msHidden";
      visibilityChange = "msvisibilitychange";
    } else if (typeof document.webkitHidden !== "undefined") {
      hidden = "webkitHidden";
      visibilityChange = "webkitvisibilitychange";
    }
     
    var videoElement = document.getElementById("videoElement");

	var id = "";
    var sessionID = 0;
    var gameSizeX = 0;
    var gameSizeY = 0;
	var x = 0;
	var y = 0;
	var newX = 0;
	var newY = 0;
	var mouseX = 0;
	var mouseY = 0;
	var speedPlayer = 0.5;
    var speedMonster = 0.55;
	var players = [];
    var bullets = [];
	var blockSize=10;
	var socket = io.connect();
	var ctx = $("#canvas")[0].getContext("2d");
    var canvas = document.getElementById("canvas");
    var showDisconnected = 0;
    var disableZombies = 0;
    var img = new Image;
    var imgLoaded = 0;
    var currentRoom = 'public';
    img.src = "";
    img.onload = function() { imgLoaded = 1; }

    // If the page is hidden, pause the video;
    // if the page is shown, play the video
    function handleVisibilityChange()
    {
        if (!document[hidden])
        {
            players = [];
            joinRoom(currentRoom);
            console.log('brought back!');
        }
        else
            console.log('hidden...');
    }

    document.addEventListener(visibilityChange, handleVisibilityChange, false);
    
    $("#dc_toggle").click(function() {
        showDisconnected = $(this).is(":checked") ? 1 : 0;
    });

    $("#zombie_toggle").click(function() {
        disableZombies = $(this).is(":checked") ? 1 : 0;
    });

    function makeTextSafe(text)
    {
        return $("<div/>").html(text).text();
    }
    function addToLog(entry)
    {
        var log = $("#event_log").html();
        log = entry + "<br />" + log;
        $("#event_log").html(log);
    }

    function updateUsername()
    {
        var name = $("#username_changer").val();
        if(name.length > 256) { alert('s-senpai, your name is too big for me...'); return; }
        socket.emit("username", {id: id, username: name, session: sessionID});
        if(localStorage !== undefined)
            localStorage.username = name;
    }

    function updateBackground()
    {
        socket.emit("updateImage", {id: id, src: $("#bg_changer").val(), session: sessionID});
    }
    
    function changeRoom()
    {
        joinRoom($("#room_changer").val());
    }

    function getHighResTime()
    {
        return (+new Date());
    }

    $("#username_button").click(updateUsername);
    $("#username_changer").keypress(function(event)
    {
        if(event.which == 13 || event.keyCode == 13) updateUsername();
    });
    $("#bg_button").click(updateBackground);
    $("#bg_changer").keypress(function(event)
    {
        if(event.which == 13 || event.keyCode == 13) updateBackground();
    });
    $("#room_button").click(changeRoom);
    $("#room_changer").keypress(function(event)
    {
        if(event.which == 13 || event.keyCode == 13) changeRoom();
    });

    function getPlayerName(playerid)
    {
        for(p=0;p<players.length;p++)
        {
            if(players[p].id!==playerid) continue;
            if(players[p].username !== undefined && players[p].username !== '')
                return '<b>Player ' + playerid + ' (' + makeTextSafe(players[p].username) + ')</b>';
            return '<b>Player ' + playerid + '</b>';
        }
        return '<b>Unknown player</b>';
    }
	
	//get id
    function joinRoom(room)
    {
        currentRoom = room;
        socket.emit("joinRoom", {room: room});
        players = [];
    }
    
    joinRoom(currentRoom);
    
	socket.on("gameState", function(data)
    {
		id=data.id;
        sessionID = data.session;
        gameSizeX = data.x;
        gameSizeY = data.y;
        $("#canvas")[0].width = gameSizeX;
        $("#canvas")[0].height = gameSizeY;
        img.src = data.image;
        imgLoaded = 0;
        console.log('connected, id ' + id + ' session ' + sessionID);
        if(localStorage !== undefined && localStorage.username !== undefined)
        {
            $("#username_changer").val(localStorage.username);
            updateUsername();
        }
	});
    
	//add new player to our list
	socket.on("newPlayer", function(data)
    {
        console.log('new player: ', data);
		players.push({id: data.id, username: data.username, x: data.x, y: data.y, newX: data.x, newY: data.y, monster: data.monster, connected: data.connected});
        addToLog('<b>New player (ID ' + data.id + ') connected!</b>');
	});
    
    //add new bullet to bullet list
    socket.on("newBullet", function(data)
    {
        console.log('new bullet: ', data);
        bullets.push({id: data.id, playerId: data.playerId, x: data.x, y: data.y, velocity: data.velocity, alive: data.alive});
    });

	//update our player list with updated player pos
	socket.on("updatePlayer", function(data)
    {
        console.log('player update: ', data);
		for(p=0;p<players.length;p++)
        {
			if(players[p].id!==data.id) continue;
            
            var player = players[p];
            
            player.newX = data.x;
            player.newY = data.y;
            if(player.absolute !== undefined && player.absolute == 1)
            {
                player.x = data.x;
                player.y = data.y;
            }
            player.connected = data.connected;
            if(player.username !== data.username && data.username !== undefined && data.username !== '')
                addToLog(getPlayerName(data.id) + ' changed name to "' + makeTextSafe(data.username) + '"');

            player.username = data.username;
            
            if(player.monster !== data.monster && data.monster == 1)
            {
                var attacker = " has become infected!";
                if(data.attackerid !== undefined && data.attackerid > 0)
                    attacker = " was bit by " + getPlayerName(data.attackerid) + "!";
                addToLog(getPlayerName(data.id) + attacker);
            }
            player.monster = data.monster;
            break;
		}
	});
    
    // Remove bullet if it's dead, otherwise update its position
    socket.on("updateBullet", function(data)
    {
        // Search through bullet array to find bullet id that needs updating
        // Works, but is pretty inefficent, ideas?
        for(i = 0; i < bullets.length; i++)
        {
            if(bullets[i].id !== data.id) continue;

            var bullet = bullets[i];

            if(data.alive == 0) {
                bullets.splice(i, 1);
            } else {
                bullet.x = data.x;
                bullet.y = data.y;
            }
            break;
        }
    });

    socket.on("refresh", function(data)
    {
        setTimeout(function(){ window.location.reload(1); }, 1000);
    });
    
    socket.on("updateImage", function(data)
    {
        addToLog(getPlayerName(data.id) + ' changed the background to <a href="' + data.src + '">' + data.src + '</a>');
        img.src = data.src;
        imgLoaded = 0;
    });
    socket.on("roundEnd", function(data)
    {
        addToLog("<b>Round ended!</b> The last survivor was " + getPlayerName(data.victimid) + " until " + getPlayerName(data.id) + " bit them.");
    });
    
    /* thanks to http://selbie.wordpress.com/2011/01/23/scale-crop-and-center-an-image-with-correct-aspect-ratio-in-html-and-javascript/ */
    function ScaleImage(srcwidth, srcheight, targetwidth, targetheight, fLetterBox)
    {
        var result = { width: 0, height: 0, fScaleToTargetWidth: true };

        if ((srcwidth <= 0) || (srcheight <= 0) || (targetwidth <= 0) || (targetheight <= 0)) {
            return result;
        }

        // scale to the target width
        var scaleX1 = targetwidth;
        var scaleY1 = (srcheight * targetwidth) / srcwidth;

        // scale to the target height
        var scaleX2 = (srcwidth * targetheight) / srcheight;
        var scaleY2 = targetheight;

        // now figure out which one we should use
        var fScaleOnWidth = (scaleX2 > targetwidth);
        if (fScaleOnWidth) {
            fScaleOnWidth = fLetterBox;
        }
        else {
           fScaleOnWidth = !fLetterBox;
        }

        if (fScaleOnWidth) {
            result.width = Math.floor(scaleX1);
            result.height = Math.floor(scaleY1);
            result.fScaleToTargetWidth = true;
        }
        else {
            result.width = Math.floor(scaleX2);
            result.height = Math.floor(scaleY2);
            result.fScaleToTargetWidth = false;
        }
        result.targetleft = Math.floor((targetwidth - result.width) / 2);
        result.targettop = Math.floor((targetheight - result.height) / 2);

        return result;
    }

    var currentTime = getHighResTime();
	function draw()
    {
        var newtime = getHighResTime();
        var frametime = newtime - currentTime;
        currentTime = newtime;

        if(gameSizeX <= 0 || gameSizeY <= 0) return;
        
		ctx.clearRect(0,0,gameSizeX,gameSizeY);
        
        if(imgLoaded == 1)
        {
            var result = ScaleImage(img.width, img.height, gameSizeX, gameSizeY, true);
            var dimensions = {width: img.width, height: img.height};
            if(dimensions.width > gameSizeX || dimensions.height > gameSizeY)
                dimensions = result;
            ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, dimensions.width, dimensions.height);
        }
		for(p=0;p<players.length;p++)
        {
            if(window.location.pathname !== '/all' && players[p].connected == 0 && showDisconnected == 0) // don't draw disconnected players
                continue;
                
            var speed = speedPlayer * (frametime / 10);
                
            if(players[p].x<players[p].newX){
                players[p].x+=speed;
            }
            if(players[p].x>players[p].newX){
                players[p].x-=speed;
            }
            if(players[p].y<players[p].newY){
                players[p].y+=speed;
            }
            if(players[p].y>players[p].newY){
                players[p].y-=speed;
            }
            
            ctx.beginPath();
            ctx.fillStyle = "#FFFFFF";
            if(players[p].id == id) // change border to red if its us
                ctx.fillStyle = "#FF0000";
                
            ctx.fillRect(players[p].x, players[p].y, 10, 10);
            
            if(players[p].monster == 1 && disableZombies === 0)
                ctx.fillStyle = "#00FF00";
            else
                ctx.fillStyle = "#000";
                
            ctx.fillRect(players[p].x + 1,players[p].y + 1,8,8);

            var name = players[p].id;
            if(players[p].username != '' && players[p].username !== undefined)
                name = name + '. ' + players[p].username;
                
            ctx.font = "12px Arial";
            ctx.textAlign = 'center';
            ctx.fillText(name, players[p].x+blockSize/2, players[p].y+blockSize+12);
            
            ctx.closePath();
		}

        // draw bullets above players
        if(disableZombies === 0)
            for(i = 0; i < bullets.length; i++)
            {
                bullets[i].x += bullets[i].velocity[0] * (frametime / 10);
                bullets[i].y += bullets[i].velocity[1] * (frametime / 10);

                ctx.beginPath();
                ctx.fillStyle = "#FF3399";
                ctx.fillRect(bullets[i].x, bullets[i].y, 5, 5);
                ctx.closePath();
            }

		ctx.beginPath();
		ctx.moveTo(mouseX,mouseY);
		ctx.lineTo(mouseX+blockSize,mouseY);
		ctx.moveTo(mouseX+blockSize,mouseY);
		ctx.lineTo(mouseX+blockSize,mouseY+blockSize);
		ctx.moveTo(mouseX+blockSize,mouseY+blockSize);
		ctx.lineTo(mouseX,mouseY+blockSize);
		ctx.moveTo(mouseX,mouseY+blockSize);
		ctx.lineTo(mouseX,mouseY);
		ctx.stroke();
		ctx.closePath();
	}

	$(document).mousemove( function(e)
    {
		var x,y;
		for(x=e.pageX-8;x>=0;x--)
        {
			if(x%blockSize==0)
            {
				mouseX = x;
				break;
			}
		}
		for(y=e.pageY-8;y>=0;y--)
        {
			if(y%blockSize==0)
            {
				mouseY = y;
				break;
			}
		}
	});
    
    $(document).mousedown(function(event)
    {
        if(event.which == 1) {
            socket.emit("position", {id: id, x: mouseX, y: mouseY, session: sessionID});
        } else if (event.which == 3) {
            socket.emit("fireBullet", {id: id, x: mouseX, y: mouseY, session: sessionID})
        }
    });
	
	setInterval(draw,10);

    // Disable context menu on canvas so that right clicks to fire bullets don't bring up menu
    canvas.oncontextmenu = function() {
        return false;
    }

var chat_open = false;
var chat_loaded = false;
var chat_channel = 'r';
function toggle_chat(){
	if (chat_open === false && chat_loaded == false) {
    	var chat_sidebar = document.getElementById("chat_sidebar");
		chat_sidebar.getElementsByTagName('iframe')[0].src = 'https://livechan.net/chat/' + chat_channel;
		document.getElementById('chat_frame').style.display = 'block';
		document.getElementById('chat_sidebar').style.top = document.width < 600 ? "20px" : '30%';
		document.getElementById('chat_button').innerHTML = '&#x25BC; hide chat - powered by livechan';
		chat_open = true;
		chat_loaded = true;
		if (document.width < 600) {
    		toggle_chat();
		}
		
	} else if (chat_open === true && chat_loaded == true){
		document.getElementById('chat_frame').style.display = 'none';
		document.getElementById('chat_sidebar').style.top = '100%';
		document.getElementById('chat_button').innerHTML = '&#x25B2; chat - powered by livechan';
		chat_open = false;
	} else if (chat_open === false && chat_loaded == true){
		document.getElementById('chat_frame').style.display = 'block';
		document.getElementById('chat_sidebar').style.top = document.width < 600 ? "20px" : '30%';
		document.getElementById('chat_button').innerHTML = '&#x25BC; hide chat - powered by livechan';
		chat_open = true;
		scroll_sidebar();
	}
	function scroll_sidebar(){
		var sidebar_check = document.getElementById("chat_frame");
		if (typeof(sidebar_check) != 'undefined' && sidebar_check != null) {
			sidebar_check.contentWindow.scroll();
		} else {
			console.log("sidebar not found :(");
		}
	}
}

toggle_chat();
</script>
</body>
</html>
